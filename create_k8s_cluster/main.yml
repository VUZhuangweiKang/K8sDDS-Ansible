---
- name: create kubernetes cluster
  host: master
  become: yes
  gather_facts: no
  vars:
    cni: "{{ cni }}"
  tasks:
    - name: generate cluster token
      shell: kubeadm token generate
      register: token
      run_once: true

    - name: create cluster with flannel cni
      shell: kubeadm init --token={{ token }} --pod-network-cidr=10.244.0.0/16
      when: token.stdout == "flannel"
    - name: create cluster with calico cni
      shell: kubeadm init --token={{ token }} --pod-network-cidr=192.168.0.0/16
      when: token.stdout == "calico"
    - name: create cluster with cilium cni
      shell: kubeadm init --token={{ token }} --pod-network-cidr=10.217.0.0/16
      when: token.stdout == "cilium"
    - name: create cluster with weavenet cni
      shell: kubeadm init
      when: token.stdout == "weavenet"
    
    - name: generate kube config
      shell: mkdir -p $HOME/.kube & cp -i /etc/kubernetes/admin.conf $HOME/.kube/config & chown $(id -u):$(id -g) $HOME/.kube/config
    
    - name: install flannel network plugin
      shell: kubectl apply -f plugins/"{{ cni }}".yaml


